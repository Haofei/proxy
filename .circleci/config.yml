version: 2.1

jobs:
  build-aarch64:
    machine:
      image: ubuntu-2004:202101-01
    resource_class: arm.medium
    steps:
      - run: uname -a

      - checkout
      - run:
         name: Update OS
         command: |
          curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
          curl https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
          sudo add-apt-repository "deb http://apt.llvm.org/focal/ llvm-toolchain-focal-16 main"
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build clang-16
          sudo rm -rf /var/lib/apt/lists/*

      - run:
          name: Check versions
          command: |
            clang-16 --version
            cmake --version

      - run:
          name: Build Classic
          command: |
            mkdir build
            cd build
            CXX=clang++-16 CC=clang-16 cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_BUILD_WERROR=OFF
            ninja -j1
            cp -r bin /tmp

      - store_artifacts:
          path: /tmp/bin

  build:
    docker:
      - image: cimg/base:edge
    steps:
      - checkout
      - run:
         name: Update OS
         command: |
          sudo apt-get update
          sudo apt-get install -y
          sudo rm -rf /var/lib/apt/lists/*

      - run:
          name: Install CMake&Ninja
          command: |
            sudo apt-get update
            sudo apt-get install -y cmake ninja-build

      - run:
          name: Check versions
          command: |
            g++ --version
            cmake --version

      - run:
          name: Build Classic
          command: |
            mkdir build
            cd build
            cmake .. -G Ninja -DCMAKE_BUILD_TYPE=Release -DENABLE_BUILD_WERROR=OFF
            ninja -j1
            cp -r bin /tmp

      - store_artifacts:
          path: /tmp/bin

workflows:
  build-workflow:
    jobs:
      - build
      - build-aarch64
